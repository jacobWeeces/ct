# ct tmux Migration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace dtach with tmux as the session backend to fix terminal freezes with Claude Code.

**Architecture:** ct becomes a thin wrapper around tmux. An embedded tmux.conf makes tmux invisible to users - mouse scrolling works, no status bar, Ctrl+\ detaches. Session detection queries tmux directly instead of tracking PID files.

**Tech Stack:** Bash, tmux (brew install tmux)

---

## Task 1: Create tmux Configuration Generator

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/ct` (complete rewrite)

**Step 1: Write the tmux config generator function**

Create a new `ct` script with just the config generator to test it works:

```bash
#!/usr/bin/env bash
set -euo pipefail

CT_DIR="${HOME}/.ct"
CT_TMUX_CONF="${CT_DIR}/tmux.conf"
DEFAULT_SHELL="${SHELL:-/bin/zsh}"

# Generate tmux configuration that makes tmux invisible
generate_tmux_conf() {
    mkdir -p "$CT_DIR"
    cat > "$CT_TMUX_CONF" << 'EOF'
# ct-managed tmux config - DO NOT EDIT
# This file is regenerated by ct

# Make tmux invisible - no status bar
set -g status off

# Large scrollback (50k lines)
set -g history-limit 50000

# Mouse support - scroll and click just work
set -g mouse on

# System clipboard integration
set -g set-clipboard on

# No delay after pressing Escape
set -g escape-time 0

# Proper terminal with colors
set -g default-terminal "xterm-256color"

# Ctrl+\ to detach (same as dtach)
unbind C-b
set -g prefix None
bind -n 'C-\' detach-client

# Don't rename windows automatically
set -g allow-rename off

# Start in the current directory for new panes/windows
set -g default-command "${SHELL}"
EOF
    echo "Generated: $CT_TMUX_CONF"
}

# Test: generate and display config
generate_tmux_conf
cat "$CT_TMUX_CONF"
```

**Step 2: Test the config generator**

```bash
chmod +x /Users/jacobweeces/Documents/connectTerm/ct
/Users/jacobweeces/Documents/connectTerm/ct
```

Expected: Outputs the tmux config file contents, file exists at `~/.ct/tmux.conf`

**Step 3: Verify tmux accepts the config**

```bash
tmux -f ~/.ct/tmux.conf new-session -d -s test-config && tmux kill-session -t test-config && echo "Config valid"
```

Expected: "Config valid" (no errors)

---

## Task 2: Add tmux Dependency Check

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/ct`

**Step 1: Add check_dependencies function**

Add after the config generator:

```bash
# Check required dependencies
check_dependencies() {
    if ! command -v tmux &> /dev/null; then
        echo "Error: tmux is not installed."
        echo ""
        echo "Install with:"
        echo "  brew install tmux"
        echo ""
        exit 1
    fi
}
```

**Step 2: Test dependency check works**

```bash
# Temporarily break PATH to simulate missing tmux
(PATH=/nonexistent:$PATH; check_dependencies)
```

Expected: Shows "Error: tmux is not installed" message

---

## Task 3: Add Session Management Functions

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/ct`

**Step 1: Add session helper functions**

```bash
# Get tmux session name from ct session name
get_tmux_session_name() {
    echo "ct-$1"
}

# Check if session exists
session_exists() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")
    tmux -f "$CT_TMUX_CONF" has-session -t "$tmux_name" 2>/dev/null
}

# Create and attach to a new session
create_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    echo "Creating new session '$name'..."
    exec tmux -f "$CT_TMUX_CONF" new-session -s "$tmux_name" "$DEFAULT_SHELL"
}

# Attach to existing session
attach_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    echo "Attaching to session '$name'..."
    exec tmux -f "$CT_TMUX_CONF" attach-session -t "$tmux_name"
}

# Start or attach to session (main entry point)
start_session() {
    local name="$1"

    # Ensure config exists
    generate_tmux_conf > /dev/null

    if session_exists "$name"; then
        attach_session "$name"
    else
        create_session "$name"
    fi
}

# Kill a session
kill_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    if ! session_exists "$name"; then
        echo "Session '$name' not found."
        return 1
    fi

    tmux -f "$CT_TMUX_CONF" kill-session -t "$tmux_name"
    echo "Session '$name' killed."
}

# List all ct sessions
list_sessions() {
    echo "Sessions:"
    echo ""

    # Get all tmux sessions, filter to ct-* ones
    local sessions
    sessions=$(tmux -f "$CT_TMUX_CONF" list-sessions -F "#{session_name}" 2>/dev/null | grep "^ct-" || true)

    if [[ -z "$sessions" ]]; then
        echo "  (no sessions)"
        return
    fi

    while IFS= read -r tmux_name; do
        local name="${tmux_name#ct-}"
        local attached
        attached=$(tmux -f "$CT_TMUX_CONF" list-sessions -F "#{session_name}:#{session_attached}" | grep "^$tmux_name:" | cut -d: -f2)

        if [[ "$attached" == "1" ]]; then
            printf "  %-20s %s\n" "$name" "✓ ATTACHED"
        else
            printf "  %-20s %s\n" "$name" "✓ ALIVE"
        fi
    done <<< "$sessions"

    echo ""
}
```

**Step 2: Test session functions individually**

```bash
# Source the script and test functions
source /Users/jacobweeces/Documents/connectTerm/ct --source-only 2>/dev/null || true

# Test get_tmux_session_name
get_tmux_session_name "work"  # Expected: ct-work

# Test session_exists on non-existent session
session_exists "nonexistent" && echo "exists" || echo "not found"  # Expected: not found
```

---

## Task 4: Add CLI Handler and Usage

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/ct`

**Step 1: Add usage and main function**

```bash
usage() {
    cat <<'EOF'
ct - ConnectTerm: Reliable terminal session manager (tmux backend)

Usage:
    ct <session>            Attach or create session
    ct -l, --list           List all sessions
    ct -k, --kill <name>    Kill specific session
    ct -h, --help           Show this help

Examples:
    ct work                 Start or attach to 'work' session
    ct -l                   Show all sessions
    ct -k work              Kill 'work' session

Session Controls (inside session):
    Ctrl+\                  Detach from session (session keeps running)
    Scroll                  Mouse/trackpad scrolling works normally

Note: This version uses tmux as the backend for better stability.
      Sessions from the old dtach version are not compatible.
EOF
}

main() {
    check_dependencies

    if [[ $# -eq 0 ]]; then
        usage
        exit 1
    fi

    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -l|--list)
            generate_tmux_conf > /dev/null
            list_sessions
            exit 0
            ;;
        -k|--kill)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --kill requires a session name"
                exit 1
            fi
            generate_tmux_conf > /dev/null
            kill_session "$2"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            start_session "$1"
            ;;
    esac
}

# Allow sourcing for testing
if [[ "${1:-}" == "--source-only" ]]; then
    return 0 2>/dev/null || exit 0
fi

main "$@"
```

**Step 2: Test CLI**

```bash
# Test help
/Users/jacobweeces/Documents/connectTerm/ct --help

# Test list (should show no sessions)
/Users/jacobweeces/Documents/connectTerm/ct -l

# Test kill non-existent
/Users/jacobweeces/Documents/connectTerm/ct -k nonexistent
```

Expected: Help displays, list shows "(no sessions)", kill shows "not found"

---

## Task 5: Assemble Complete Script

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/ct` (final assembly)

**Step 1: Write the complete ct script**

Combine all parts into the final script in order:
1. Shebang and set options
2. Variables (CT_DIR, CT_TMUX_CONF, DEFAULT_SHELL)
3. generate_tmux_conf()
4. check_dependencies()
5. Session functions (get_tmux_session_name, session_exists, create_session, attach_session, start_session, kill_session, list_sessions)
6. usage()
7. main()
8. Source guard and main call

**Step 2: Verify syntax**

```bash
bash -n /Users/jacobweeces/Documents/connectTerm/ct && echo "Syntax OK"
```

Expected: "Syntax OK"

**Step 3: Run full test sequence**

```bash
# List (empty)
/Users/jacobweeces/Documents/connectTerm/ct -l

# Help
/Users/jacobweeces/Documents/connectTerm/ct --help
```

Expected: Both work without errors

**Step 4: Commit**

```bash
git add ct
git commit -m "feat: replace dtach with tmux backend for better stability

- Complete rewrite using tmux instead of dtach
- Embedded tmux.conf makes tmux invisible (no status bar, mouse works)
- Ctrl+\ detaches (same as dtach)
- Simpler code - no PID tracking, no zombie detection
- Large scrollback (50k lines), system clipboard support

This should fix terminal freezes when using Claude Code through Termius.
Backup of dtach version: git checkout v1.0-dtach"
```

---

## Task 6: Update README

**Files:**
- Modify: `/Users/jacobweeces/Documents/connectTerm/README.md`

**Step 1: Update README with tmux information**

Key changes:
- Update "How It Works" architecture diagram
- Update "Dependencies" to show tmux instead of dtach
- Remove dtach-specific troubleshooting (zombie detection, etc.)
- Update "Session Controls" to mention Ctrl+\ detach
- Add note about incompatibility with old dtach sessions

**Step 2: Commit README**

```bash
git add README.md
git commit -m "docs: update README for tmux backend"
```

---

## Task 7: Integration Test

**Step 1: Install and test end-to-end**

```bash
# Install
/Users/jacobweeces/Documents/connectTerm/install.sh

# Create a test session
ct test-session
# (Inside session: type some commands, scroll up, then Ctrl+\ to detach)

# List sessions
ct -l

# Reattach
ct test-session
# (Verify scrollback is preserved, then Ctrl+\ to detach)

# Kill session
ct -k test-session

# Verify it's gone
ct -l
```

**Step 2: Push to GitHub**

```bash
git push
```

---

## Rollback Procedure

If the tmux version doesn't work:

```bash
git checkout v1.0-dtach -- ct README.md
./install.sh
```
