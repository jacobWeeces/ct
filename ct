#!/usr/bin/env bash
set -euo pipefail

# ============================================================================
# ct - ConnectTerm: Reliable terminal session manager (tmux backend)
# ============================================================================

CT_DIR="${HOME}/.ct"
CT_TMUX_CONF="${CT_DIR}/tmux.conf"
DEFAULT_SHELL="${SHELL:-/bin/zsh}"

# ============================================================================
# tmux Configuration Generation
# ============================================================================

generate_tmux_conf() {
    mkdir -p "$CT_DIR"

    cat > "$CT_TMUX_CONF" <<'EOF'
# ct tmux configuration - makes tmux invisible to users
# This config is auto-generated by ct - do not edit manually

# Hide status bar - no tmux UI visible
set -g status off

# Large scrollback buffer
set -g history-limit 50000

# Enable mouse support - scroll and click work naturally
set -g mouse on

# Enable system clipboard integration
set -g set-clipboard on

# No delay for Escape key (important for vim users)
set -g escape-time 0

# Terminal type for proper color support
set -g default-terminal "xterm-256color"

# Detach key: Ctrl+\ (same as dtach)
# This overrides the default Ctrl+B prefix behavior
unbind C-b
set -g prefix None
bind-key -n C-\ detach-client

# Disable confirmation prompts for a smoother experience
bind-key & kill-window
bind-key x kill-pane

# Start shell as login shell
set -g default-command "${SHELL} -l"
EOF
}

# ============================================================================
# Dependency Check
# ============================================================================

check_dependencies() {
    if ! command -v tmux &>/dev/null; then
        cat <<EOF
Error: tmux is not installed.

ct requires tmux for session management. To install:

  macOS:    brew install tmux
  Ubuntu:   sudo apt-get install tmux
  Fedora:   sudo dnf install tmux

After installation, run ct again.
EOF
        exit 1
    fi
}

# ============================================================================
# Session Management Functions
# ============================================================================

# Convert session name to tmux session name
# Example: "work" -> "ct-work"
get_tmux_session_name() {
    local name="$1"
    echo "ct-${name}"
}

# Check if a session exists
session_exists() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")
    tmux has-session -t "$tmux_name" 2>/dev/null
}

# Create a new session
create_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    echo "Creating new session '$name'..."

    # Create new session in detached mode with our config
    # -d = detached, -s = session name, -c = start directory
    # Shell is started as login shell via default-command in config
    tmux -f "$CT_TMUX_CONF" new-session -d -s "$tmux_name" -c "$HOME"
}

# Attach to existing session
attach_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    echo "Attaching to existing session '$name'..."

    # Attach to session using our config
    # This will inherit the tmux configuration from the running session
    exec tmux -f "$CT_TMUX_CONF" attach-session -t "$tmux_name"
}

# Main session start logic - create or attach
start_session() {
    local name="$1"

    if session_exists "$name"; then
        attach_session "$name"
    else
        create_session "$name"
        attach_session "$name"
    fi
}

# Kill a specific session
kill_session() {
    local name="$1"
    local tmux_name
    tmux_name=$(get_tmux_session_name "$name")

    if ! session_exists "$name"; then
        echo "Error: Session '$name' does not exist."
        return 1
    fi

    tmux kill-session -t "$tmux_name"
    echo "Session '$name' killed."
}

# List all ct-* sessions with status
list_sessions() {
    echo "ct sessions:"
    echo ""

    # Get all tmux sessions, filter for ct-* prefix
    local sessions
    sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^ct-" || true)

    if [[ -z "$sessions" ]]; then
        echo "  (no sessions)"
        echo ""
        return
    fi

    # Display each session with status
    while IFS= read -r tmux_name; do
        # Strip "ct-" prefix to get user-facing name
        local name="${tmux_name#ct-}"

        # Get session info
        local attached
        attached=$(tmux list-sessions -F "#{session_name} #{session_attached}" 2>/dev/null | grep "^${tmux_name} " | awk '{print $2}')

        if [[ "$attached" == "1" ]]; then
            printf "  %-20s %s\n" "$name" "(attached)"
        else
            printf "  %-20s %s\n" "$name" "(detached)"
        fi
    done <<< "$sessions"

    echo ""
}

# ============================================================================
# CLI Handler
# ============================================================================

usage() {
    cat <<EOF
ct - ConnectTerm: Reliable terminal session manager

Usage:
    ct <session>            Attach or create session
    ct -l, --list           List all sessions
    ct -k, --kill <name>    Kill specific session
    ct -h, --help           Show this help

Examples:
    ct work                 Start or attach to 'work' session
    ct -l                   Show all sessions
    ct -k work              Kill 'work' session

Detaching:
    Press Ctrl+\            Detach from session (session keeps running)

Features:
    - Sessions persist after detaching
    - Mouse scrolling and selection work naturally
    - System clipboard integration (copy/paste just works)
    - Large scrollback buffer (50,000 lines)
    - No tmux learning curve - works like a normal terminal

Session Files:
    Configuration: ${CT_TMUX_CONF}
EOF
}

main() {
    # Check dependencies first
    check_dependencies

    # Generate tmux config if it doesn't exist or is outdated
    if [[ ! -f "$CT_TMUX_CONF" ]]; then
        generate_tmux_conf
    fi

    # Handle no arguments
    if [[ $# -eq 0 ]]; then
        usage
        exit 1
    fi

    # Parse command
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -l|--list)
            list_sessions
            exit 0
            ;;
        -k|--kill)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --kill requires a session name"
                echo "Usage: ct -k <session>"
                exit 1
            fi
            if ! kill_session "$2"; then
                exit 1
            fi
            exit 0
            ;;
        -*)
            echo "Error: Unknown option: $1"
            echo ""
            usage
            exit 1
            ;;
        *)
            # Session name provided - start or attach
            start_session "$1"
            ;;
    esac
}

# ============================================================================
# Entry Point
# ============================================================================

# Allow sourcing for tests
if [[ "${1:-}" == "--source-only" ]]; then
    return 0 2>/dev/null || exit 0
fi

main "$@"
